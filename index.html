<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prep Plan • Akshay — AI Study Assistants</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Using Tailwind CSS for a cleaner, utility-first approach */
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a; /* slate-900 */
    }
    .tag {
      display: inline-block;
      padding: 0.25rem 0.6rem;
      border-radius: 9999px; /* Pill shape */
      font-weight: 600;
      font-size: 0.8rem;
      border: 1px solid transparent;
    }
    /* Dark theme tag colors */
    .c101{background-color: #102d20; color: #6ee7b7; border-color: #15803d;}
    .c103{background-color: #2a220c; color: #fde047; border-color: #a16207;}
    .c105{background-color: #0c2a38; color: #67e8f9; border-color: #0e7490;}
    .c107{background-color: #3b0f15; color: #fda4af; border-color: #9f1239;}

    /* Chat Modal Styling */
    #chat-modal-backdrop {
        transition: opacity 0.3s ease-in-out;
    }
    #chat-modal {
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
    }
    .card {
        border-top: 3px solid #60a5fa; /* Brighter blue accent */
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
    }
    /* Spinner animation */
    .loader {
        border: 4px solid #384252;
        border-top: 4px solid #60a5fa;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-slate-900 text-slate-300">

  <header class="bg-slate-800/50 backdrop-blur-lg border-b border-slate-700 text-white sticky top-0 z-40">
    <div class="max-w-6xl mx-auto p-4 flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold tracking-tight text-slate-100">IIT Patna CSDA Launchpad</h1>
        <p class="text-sm text-slate-400 mt-1">Your 3-day prep plan by Akshay</p>
      </div>
      <nav class="hidden md:flex items-center space-x-2">
        <a href="#timetable" class="px-3 py-2 rounded-md hover:bg-slate-700 transition-colors font-medium">Timetable</a>
        <a href="#prep-plan" class="px-3 py-2 rounded-md hover:bg-slate-700 transition-colors font-medium">Prep Plan</a>
        <a href="#materials" class="px-3 py-2 rounded-md hover:bg-slate-700 transition-colors font-medium">Materials</a>
        <a href="#ai" class="px-3 py-2 rounded-md hover:bg-slate-700 transition-colors font-medium">AI Assistants</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-8">

    <!-- Timetable -->
    <section id="timetable" class="card bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-4 text-slate-100">Semester I Timetable</h2>
      <div class="overflow-x-auto rounded-lg border border-slate-700">
        <table class="w-full min-w-[900px] text-sm text-center">
          <thead class="bg-slate-700">
            <tr>
              <th class="p-3 font-semibold text-slate-300">Day / Time</th>
              <th class="p-3 font-semibold text-slate-300">08:00-08:55</th><th class="p-3 font-semibold text-slate-300">09:00-09:55</th><th class="p-3 font-semibold text-slate-300">10:00-10:55</th><th class="p-3 font-semibold text-slate-300">11:00-11:55</th><th class="p-3 font-semibold text-slate-300">12:00-12:55</th><th class="p-3 font-semibold text-slate-300">01:00-01:55</th><th class="p-3 font-semibold text-slate-300">02:00-02:55</th><th class="p-3 font-semibold text-slate-300">03:00-03:55</th><th class="p-3 font-semibold text-slate-300">04:00-04:55</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-700">
            <tr class="bg-slate-800">
                <td class="p-3 font-medium">Monday</td>
                <td colspan="2" class="c105"><span class="tag c105">CDA 105</span></td>
                <td></td><td></td><td></td>
                <td class="c107"><span class="tag c107">CDA 107</span></td>
                <td colspan="3" class="c103"><span class="tag c103">CDA 103 Lab</span></td>
            </tr>
            <tr class="bg-slate-900">
                <td class="p-3 font-medium">Tuesday</td>
                <td></td>
                <td colspan="2" class="c101"><span class="tag c101">CDA 101</span></td>
                <td></td><td></td>
                <td class="c107"><span class="tag c107">CDA 107</span></td>
                <td></td>
                <td colspan="2" class="c103"><span class="tag c103">CDA 103</span></td>
            </tr>
            <tr class="bg-slate-800">
                <td class="p-3 font-medium">Wednesday</td>
                <td colspan="2" class="c105"><span class="tag c105">CDA 105</span></td>
                <td></td><td></td><td></td>
                <td class="c107"><span class="tag c107">CDA 107</span></td>
                <td></td>
                <td colspan="2" class="c103"><span class="tag c103">CDA 103</span></td>
            </tr>
            <tr class="bg-slate-900">
                <td class="p-3 font-medium">Thursday</td>
                <td colspan="6"></td>
                <td class="c107"><span class="tag c107">CDA 107</span></td>
                <td colspan="2" class="c103"><span class="tag c103">CDA 103</span></td>
            </tr>
            <tr class="bg-slate-800">
                <td class="p-3 font-medium">Friday</td>
                <td colspan="9" class="text-slate-500">No scheduled lectures</td>
            </tr>
            <tr class="bg-slate-900">
                <td class="p-3 font-medium">Saturday</td>
                <td></td>
                <td colspan="2" class="c101"><span class="tag c101">CDA 101</span></td>
                <td colspan="2" class="c105"><span class="tag c105">CDA 105 Lab</span></td>
                <td colspan="4"></td>
            </tr>
            <tr class="bg-slate-800">
                <td class="p-3 font-medium">Sunday</td>
                <td colspan="9" class="text-slate-500">Holiday</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Prep Plan -->
    <section id="prep-plan" class="card bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-1 text-slate-100">✨ AI-Powered Prep Plan</h2>
      <p class="text-slate-400 mb-6">Let Gemini create a custom study plan for you.</p>
      
      <form id="plan-generator-form" class="flex items-center gap-4 p-4 bg-slate-800/50 border border-slate-700 rounded-lg">
        <label for="study-days" class="font-semibold text-slate-300">How many days to prepare?</label>
        <input type="number" id="study-days" value="3" min="1" max="14" class="bg-slate-700 text-slate-200 border border-slate-600 rounded-lg px-3 py-2 w-24 focus:ring-2 focus:ring-blue-500 focus:outline-none">
        <button type="submit" class="bg-blue-600 text-white font-semibold px-5 py-2 rounded-lg hover:bg-blue-500 transition-colors flex items-center gap-2">
          <i data-lucide="wand-2" class="w-5 h-5"></i> Generate Plan
        </button>
      </form>
      
      <div id="plan-output" class="mt-6">
        <!-- Generated plan will be displayed here -->
      </div>
       <div id="plan-loader" class="hidden justify-center items-center mt-6 flex-col gap-4">
          <div class="loader"></div>
          <p class="text-slate-400">Generating your custom plan...</p>
      </div>
    </section>

    <!-- Materials -->
    <section id="materials" class="card bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-4 text-slate-100">Study Materials</h2>
      <div class="grid sm:grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col">
          <h3 class="font-bold text-slate-200">CDA 101 — Mathematics-I</h3>
          <ul class="text-sm text-slate-400 mt-2 flex-1 space-y-2">
            <li><a href="Calculus  Analytical Geometry_9e_ Thomas_Finney.pdf" class="text-blue-400 hover:underline">Calculus & Analytical Geometry</a></li>
            <li><a href="Introduction to Probability Theory_3e_Hoel et. al.pdf" class="text-blue-400 hover:underline">Intro to Probability Theory</a></li>
            <li><a href="Probability_ Random Processes_3e_ Grimmett et. al.pdf" class="text-blue-400 hover:underline">Probability & Random Processes</a></li>
          </ul>
        </div>
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col">
          <h3 class="font-bold text-slate-200">CDA 103 — Foundation of CS</h3>
           <ul class="text-sm text-slate-400 mt-2 flex-1 space-y-2">
            <li><a href="How to Solve it By Computer_ Dromey.pdf" class="text-blue-400 hover:underline">How to Solve it By Computer</a></li>
            <li><a href="Python Programming_3e _Dawson.pdf" class="text-blue-400 hover:underline">Python Programming</a></li>
            <li><a href="Python Workbook _Stephenson.pdf" class="text-blue-400 hover:underline">Python Workbook</a></li>
          </ul>
        </div>
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col">
          <h3 class="font-bold text-slate-200">CDA 105 — Data Analytics</h3>
           <ul class="text-sm text-slate-400 mt-2 flex-1 space-y-2">
            <li><a href="Python Data Science_ Handbook_ VanderPlas.pdf" class="text-blue-400 hover:underline">Python Data Science Handbook</a></li>
            <li><a href="Visual Display of Quantitative Information_2e_ Tufte.pdf" class="text-blue-400 hover:underline">Visual Display of Info</a></li>
          </ul>
        </div>
        <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-4 flex flex-col">
          <h3 class="font-bold text-slate-200">CDA 107 — English for Professionals</h3>
           <ul class="text-sm text-slate-400 mt-2 flex-1 space-y-2">
            <li><a href="English Grammar In Use_5e_ Murphy.pdf" class="text-blue-400 hover:underline">English Grammar In Use</a></li>
            <li><a href="Practical English Usage_4e_Swan.pdf" class="text-blue-400 hover:underline">Practical English Usage</a></li>
          </ul>
        </div>
      </div>
    </section>

    <!-- AI Assistants -->
    <section id="ai" class="card bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
      <h2 class="text-3xl font-bold mb-1 text-slate-100">AI Assistants</h2>
      <p class="text-slate-400 mb-6">Click a subject to start a chat with a specialized AI assistant.</p>
      <div class="flex gap-4 flex-wrap">
        <button class="bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-blue-500 transition-all shadow-lg hover:shadow-blue-500/40 transform hover:-translate-y-0.5 flex items-center gap-2" onclick="openChat('CDA 101 — Mathematics-I', 'math')"><i data-lucide="calculator" class="w-5 h-5"></i> Mathematics AI</button>
        <button class="bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-blue-500 transition-all shadow-lg hover:shadow-blue-500/40 transform hover:-translate-y-0.5 flex items-center gap-2" onclick="openChat('CDA 103 — Foundation of Computer Science', 'cs')"><i data-lucide="code" class="w-5 h-5"></i> Computer Science AI</button>
        <button class="bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-blue-500 transition-all shadow-lg hover:shadow-blue-500/40 transform hover:-translate-y-0.5 flex items-center gap-2" onclick="openChat('CDA 105 — Foundation of Data Analytics', 'da')"><i data-lucide="bar-chart-3" class="w-5 h-5"></i> Data Analytics AI</button>
        <button class="bg-blue-600 text-white font-semibold px-5 py-3 rounded-lg hover:bg-blue-500 transition-all shadow-lg hover:shadow-blue-500/40 transform hover:-translate-y-0.5 flex items-center gap-2" onclick="openChat('CDA 107 — Foundation of English for Professionals', 'eng')"><i data-lucide="pen-square" class="w-5 h-5"></i> English AI</button>
      </div>
    </section>

    <!-- Credits -->
    <footer class="text-center text-slate-400 text-sm py-8">
      <p class="text-lg font-bold text-slate-300">Made by <span class="text-blue-400 tracking-wider">Akshay</span></p>
      <div class="mt-4 flex justify-center items-center space-x-6">
        <a href="https://www.instagram.com/___mr._.anonymous___?igsh=aHVpazUwc3htdm54" target="_blank" class="text-slate-400 hover:text-blue-400 transition-colors p-2 rounded-full hover:bg-slate-700">
          <i data-lucide="instagram" class="w-6 h-6"></i>
        </a>
        <a href="https://www.linkedin.com/in/akshaymehta7?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" class="text-slate-400 hover:text-blue-400 transition-colors p-2 rounded-full hover:bg-slate-700">
          <i data-lucide="linkedin" class="w-6 h-6"></i>
        </a>
      </div>
    </footer>
  </main>

  <!-- Chat Modal -->
  <div id="chat-modal-backdrop" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden opacity-0" onclick="closeChat()"></div>
  <div id="chat-modal" class="fixed inset-0 m-auto w-full max-w-2xl h-[85vh] bg-slate-800 rounded-xl shadow-2xl flex flex-col z-50 hidden opacity-0 scale-95 border border-slate-700">
    <div class="flex justify-between items-center p-4 border-b border-slate-700">
      <h3 id="chat-subject" class="text-lg font-bold text-slate-200">AI Assistant</h3>
      <button onclick="closeChat()" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <div id="chat-messages" class="flex-1 p-4 overflow-y-auto bg-slate-900">
      <!-- Messages will be appended here -->
    </div>
    <div class="p-4 border-t border-slate-700 bg-slate-800">
      <form id="chat-form" class="flex gap-2">
        <button type="button" id="new-problem-btn" class="bg-slate-700 text-slate-200 font-semibold px-4 py-2 rounded-lg hover:bg-slate-600 transition-colors flex items-center gap-2">✨ New Problem</button>
        <input id="chat-input" class="w-full px-4 py-2 bg-slate-700 text-slate-200 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Ask a question..." autocomplete="off" />
        <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-500 transition-colors flex items-center justify-center"><i data-lucide="send" class="w-5 h-5"></i></button>
      </form>
    </div>
  </div>


  <script>
    lucide.createIcons();
    
    // --- UI Elements ---
    const chatModalBackdrop = document.getElementById('chat-modal-backdrop');
    const chatModal = document.getElementById('chat-modal');
    const chatSubject = document.getElementById('chat-subject');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const newProblemBtn = document.getElementById('new-problem-btn');
    const planGeneratorForm = document.getElementById('plan-generator-form');
    const planOutput = document.getElementById('plan-output');
    const planLoader = document.getElementById('plan-loader');
    const studyDaysInput = document.getElementById('study-days');

    // --- State ---
    let activeSubjectKey = null;
    let chatHistory = [];

    // --- System Prompts ---
    const systemPrompts = {
      'math': "You are a helpful teaching assistant for CDA 101: Mathematics-I. Answer clearly and show step-by-step when relevant. Keep explanations short and include 1 example if possible.",
      'cs': "You are a helpful teaching assistant for CDA 103: Foundation of Computer Science. Explain programming and algorithm concepts simply with code examples when relevant. Keep answers concise.",
      'da': "You are a helpful teaching assistant for CDA 105: Foundation of Data Analytics. Explain data concepts, stats, and practical steps for cleaning/visualizing data in short actionable steps.",
      'eng': "You are a helpful teaching assistant for CDA 107: Foundation of English for Professionals. Focus on grammar, writing clarity, and professional communication tips."
    };

    // --- Chat Functions ---
    function openChat(title, subjectKey) {
      activeSubjectKey = subjectKey;
      chatSubject.textContent = title;
      chatMessages.innerHTML = '';
      chatHistory = [];

      chatModalBackdrop.classList.remove('hidden');
      chatModal.classList.remove('hidden');
      setTimeout(() => {
        chatModalBackdrop.classList.remove('opacity-0');
        chatModal.classList.remove('opacity-0', 'scale-95');
      }, 10);

      const welcomeMessage = `Hello! I'm your ${title} assistant. How can I help you with this subject?`;
      appendAIMessage(welcomeMessage);
      chatHistory.push({ role: "model", parts: [{ text: welcomeMessage }] });
    }

    function closeChat() {
      chatModalBackdrop.classList.add('opacity-0');
      chatModal.classList.add('opacity-0', 'scale-95');
      setTimeout(() => {
        chatModalBackdrop.classList.add('hidden');
        chatModal.classList.add('hidden');
      }, 300);
    }

    function appendUserMessage(text) {
      chatMessages.innerHTML += `<div class="flex justify-end mb-3">
        <div class="bg-blue-600 text-white rounded-lg py-2 px-4 max-w-[80%]">
          ${text}
        </div>
      </div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function appendAIMessage(html) {
      const thinkingBubble = chatMessages.querySelector('.thinking');
      if (thinkingBubble) {
        thinkingBubble.remove();
      }
      chatMessages.innerHTML += `<div class="flex justify-start mb-3">
        <div class="bg-slate-700 text-slate-200 rounded-lg py-2 px-4 max-w-[80%] border border-slate-600">
          ${html.replace(/\n/g, '<br>')}
        </div>
      </div>`;
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function showThinkingIndicator() {
      chatMessages.innerHTML += `<div class="flex justify-start mb-3 thinking">
        <div class="bg-slate-700 rounded-lg py-2 px-4 border border-slate-600">
          <div class="flex items-center space-x-1">
            <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0s;"></span>
            <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></span>
            <span class="w-2 h-2 bg-slate-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></span>
          </div>
        </div>
      </div>`;
       chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;

      appendUserMessage(userMessage);
      chatInput.value = '';
      showThinkingIndicator();

      chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

      try {
        const aiReply = await callGemini(activeSubjectKey, chatHistory);
        chatHistory.push({ role: "model", parts: [{ text: aiReply }] });
        appendAIMessage(aiReply);
      } catch (err) {
        appendAIMessage(`Sorry, something went wrong: ${err.message}`);
      }
    });
    
    // --- New Feature: Practice Problem Generator ---
    newProblemBtn.addEventListener('click', async () => {
        const subjectName = chatSubject.textContent;
        const prompt = `Generate a practice problem for a first-year university student studying ${subjectName}.`;
        
        appendUserMessage("✨ Generate a new practice problem for me.");
        showThinkingIndicator();

        const tempHistory = [{ role: "user", parts: [{ text: prompt }] }];

        try {
            const aiReply = await callGemini(activeSubjectKey, tempHistory);
            appendAIMessage(aiReply);
        } catch (err) {
            appendAIMessage(`Sorry, I couldn't generate a problem: ${err.message}`);
        }
    });

    // --- New Feature: AI Prep Plan Generator ---
    planGeneratorForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const days = studyDaysInput.value;
        if (!days || days < 1) {
            planOutput.innerHTML = `<p class="text-red-400">Please enter a valid number of days.</p>`;
            return;
        }

        planLoader.style.display = 'flex';
        planOutput.innerHTML = '';

        const prompt = `Create a ${days}-day study plan for a first-year university student taking four subjects: Mathematics-I (Calculus, Probability), Foundation of CS (Python basics), Data Analytics (Data lifecycle, EDA), and English for Professionals (Grammar, Writing). Allocate study time reasonably across the subjects each day.`;

        const planSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    day: { type: "NUMBER" },
                    tasks: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                subject: { type: "STRING" },
                                duration: { type: "STRING" },
                                topic: { type: "STRING" }
                            },
                            required: ["subject", "duration", "topic"]
                        }
                    }
                },
                required: ["day", "tasks"]
            }
        };

        try {
            const planData = await callGeminiWithSchema(prompt, planSchema);
            renderPlan(planData);
        } catch (err) {
            planOutput.innerHTML = `<p class="text-red-400">Error generating plan: ${err.message}</p>`;
        } finally {
            planLoader.style.display = 'none';
        }
    });

    function renderPlan(planData) {
        if (!planData || !Array.isArray(planData)) {
            planOutput.innerHTML = `<p class="text-red-400">Could not generate a valid plan structure. Please try again.</p>`;
            return;
        }
        let html = '<div class="grid md:grid-cols-3 gap-6">';
        planData.forEach(day => {
            html += `
                <div class="bg-slate-800/50 border border-slate-700 rounded-lg p-5">
                    <h3 class="font-bold text-lg mb-3 text-slate-200">Day ${day.day}</h3>
                    <ul class="space-y-2 text-slate-400 list-none">`;
            day.tasks.forEach(task => {
                html += `<li><strong>${task.subject} (${task.duration}):</strong> ${task.topic}</li>`;
            });
            html += `</ul></div>`;
        });
        html += '</div>';
        planOutput.innerHTML = html;
    }


    // --- Gemini API Calls (FIXED & ROBUST) ---
    async function callWithBackoff(apiUrl, payload, retries = 3, delay = 1000) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                if (retries > 0 && response.status >= 500) {
                    await new Promise(res => setTimeout(res, delay));
                    return callWithBackoff(apiUrl, payload, retries - 1, delay * 2);
                }
                throw new Error(`API Error ${response.status}: ${await response.text()}`);
            }
            return response.json();
        } catch (error) {
            if (retries > 0) {
                await new Promise(res => setTimeout(res, delay));
                return callWithBackoff(apiUrl, payload, retries - 1, delay * 2);
            }
            throw error;
        }
    }

    async function callGemini(subjectKey, history) {
        const payload = {
            contents: history,
            systemInstruction: {
                parts: [{ text: systemPrompts[subjectKey] || "You are a helpful assistant." }]
            }
        };
        const apiKey = "AIzaSyBXDY2iC-tcGyCkZY_tB-vCpKqVh2tC8MA";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const result = await callWithBackoff(url, payload);
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!text) {
            if (result.candidates?.[0]?.finishReason) {
                return `Response blocked. Reason: ${result.candidates[0].finishReason}`;
            }
            throw new Error("Received an empty response from the API.");
        }
        return text;
    }
    
    async function callGeminiWithSchema(prompt, schema) {
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
                responseSchema: schema
            }
        };
        const apiKey = "AIzaSyBXDY2iC-tcGyCkZY_tB-vCpKqVh2tC8MA";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const result = await callWithBackoff(url, payload);
        const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
        
        if (!jsonText) {
            throw new Error("Received an empty JSON response from the API.");
        }
        
        try {
            return JSON.parse(jsonText);
        } catch (e) {
            console.error("Failed to parse JSON response:", jsonText);
            throw new Error("The AI returned an invalid data format. Please try again.");
        }
    }

  </script>
</body>
</html>
